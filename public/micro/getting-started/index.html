

<!DOCTYPE html>
<html>
  <head>
    <title>
	Getting Started :: Lucid
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2020-10-29T18:00:25 UTC">
<meta name="description" content="">



<title>Getting Started :: Lucid</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='http://localhost:1313/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "http:\/\/localhost:1313\/";
</script>


<link rel="stylesheet" href="/css/custom.css">

<link rel="apple-touch-icon" sizes="180x180" href="/icon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16x16.png">
<link rel="manifest" href="/icon/site.webmanifest">

<script async defer src="https://buttons.github.io/buttons.js"></script>


    
  </head>

  <body data-url="/micro/getting-started/"

  class="hideheader ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    

    <article>
      
      <aside class="">
        
<div class="search">
	<div class="searchbox">
	  <input data-search-input id="search-by" type="text" placeholder="Type to search...">
	</div>
	<script type="text/javascript" src="/vendor/lunr/lunr.min.js"></script>
	<script type="text/javascript" src="/vendor/auto-complete/auto-complete.js"></script>
	<link href="/vendor/auto-complete/auto-complete.css" rel="stylesheet">
	<script type="text/javascript">
	  
	      var baseurl = "http:\/\/localhost:1313\/";
	  
	</script>
	<script type="text/javascript" src="/js/search.js"></script>
</div>

		
	
			
		
	    	<div style="margin-top: 30px;">
    <a href="/" style="display: flex; justify-content: left; align-items: center;">
        <img src="/icon/lucid-icon.svg" width="100" height="100" style="margin-left: 15px;"/>
        <h2 style="margin-top: -14px;">Lucid</h2>
    </a>
</div>

	    
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="http://localhost:1313/introduction/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/introduction/">Introduction</a>
      
    </li>
    

    <li data-nav-id="http://localhost:1313/philosophy/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/philosophy/">Philosophy</a>
      
    </li>
    
<hr />
    <li data-nav-id="http://localhost:1313/routing/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/routing/">Routing</a>
      
    </li>
    

    <li data-nav-id="http://localhost:1313/controllers/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/controllers/">Controllers</a>
      
    </li>
    

    <li data-nav-id="http://localhost:1313/features/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/features/">Features</a>
      
    </li>
    

    <li data-nav-id="http://localhost:1313/jobs/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/jobs/">Jobs</a>
      
    </li>
    

    <li data-nav-id="http://localhost:1313/operations/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/operations/">Operations</a>
      
    </li>
    
<hr />
    <li data-nav-id="http://localhost:1313/monolith/" class="dd-item haschildren
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/monolith/">Monolith</a>
      
        <ul>
              

    <li data-nav-id="http://localhost:1313/monolith/installation/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      
          <a href="/monolith/installation/">Installation</a>
      

      
    </li>
              

    <li data-nav-id="http://localhost:1313/monolith/getting-started/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      
          <a href="/monolith/getting-started/">Getting Started</a>
      

      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="http://localhost:1313/micro/" class="dd-item parent haschildren
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/micro/">Micro</a>
      
        <ul>
              

    <li data-nav-id="http://localhost:1313/micro/installation/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      
          <a href="/micro/installation/">Installation</a>
      

      
    </li>
              

    <li data-nav-id="http://localhost:1313/micro/getting-started/" class="dd-item parent active
        alwaysopen
        item_level_$level
        ">

      
      

      
          <a href="/micro/getting-started/">Getting Started</a>
      

      
    </li>
        </ul>
    </li>
    
<hr />
    <li data-nav-id="http://localhost:1313/cli/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/cli/">CLI Reference</a>
      
    </li>
    

    <li data-nav-id="http://localhost:1313/contribution-guide/" class="dd-item
        alwaysopen
        item_level_$level
        ">

      
      

      

      
          <a href="/contribution-guide/">Contribution Guide</a>
      
    </li>
    



</ul>

		
	
			
		
	    	
	    
	
      </aside>
      

      <section class="page ">
      
	
		
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
	<li >
      <a class="text-link" href="http://localhost:1313/">
        Home
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/micro/">
        Micro
      </a>
    </li>
	
  	
  
    <li class="active">
      
        Getting Started
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>Getting Started</h1>
        

		
										
		

		
	

	
	
	<div class="jump-to-section">
		<span onclick="$h = $(this);$h.next('nav').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('nav').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
  			<span class="fas fa-align-right"></span>
  			Jump to Section
  			<i style=";" class="fas fa-chevron-right"></i>
		</span>
		<nav id="TableOfContents">
  <ul>
    <li><a href="#brief">Brief</a>
      <ul>
        <li><a href="#writing-features">Writing Features</a></li>
        <li><a href="#writing-operations">Writing Operations</a></li>
        <li><a href="#writing-jobs">Writing Jobs</a></li>
      </ul>
    </li>
    <li><a href="#code">Code</a>
      <ul>
        <li><a href="#step-1---validate-input">Step 1 - Validate Input</a></li>
        <li><a href="#step-2---authorise-access">Step 2 - Authorise Access</a></li>
        <li><a href="#step-3---save-article">Step 3 - Save Article</a></li>
        <li><a href="#step-4---add-audit-entry-asynchronously">Step 4 - Add audit entry asynchronously</a></li>
        <li><a href="#step-5---notify-followers">Step 5 - Notify Followers</a></li>
        <li><a href="#step-6---respond-with-update-status">Step 6 - Respond with Update Status</a></li>
        <li><a href="#step-7----finally-compose-feature">Step 7 -  Finally: Compose Feature</a></li>
      </ul>
    </li>
    <li><a href="#notable-observation">Notable Observation</a></li>
    <li><a href="#faq">FAQ</a></li>
    <li><a href="#where-to-go-from-here">Where To Go From Here?</a></li>
  </ul>
</nav>
	</div>
	
	






	<div class="content">
	    <p>In here we describe a suggested workflow to build a working feature and its tests, using time efficiently
and showcasing how Lucid enhances productivity and output.</p>
<hr>
<p>Building applications is as similar in concept as building any artefact made of multiple pieces such as houses, towers, castles etc. which are all built on the basis of the same construct - stone walls. For that we need material, structure, measurements and most importantly sequence; for we need the base layer of stones and cement to build upon, and it is built row by row.</p>
<p>In this guide we show the recommended process of building robust (yet flexible) blocks that make our application whole, ensuring ideal levels of productivity and efficiency by outlining the composition and interaction of our units prior to indulging into implementation - <strong><a href="https://books.google.com.ua/books?id=TVQUAAAAQBAJ&amp;lpg=PA11&amp;ots=O_P4gAod-X&amp;dq=thinking%20time%20peopleware&amp;hl=uk&amp;pg=PA11#v=onepage&amp;q&amp;f=false">Thinking time</a></strong> as described in <a href="https://en.wikipedia.org/wiki/Peopleware:_Productive_Projects_and_Teams">Peopleware</a> is the objective of this workflow.</p>
<h2 ref="brief" >Brief</h2><a class="anchor" id="brief"></a>
<h3 ref="writing-features" >Writing Features</h3><a class="anchor" id="writing-features"></a>
<ol>
<li>
<p>Generate a Feature class, which will create its test class along.</p>
</li>
<li>
<p>Open the Feature class and describe the steps to achieve the feature&rsquo;s functionality in <code>TODO</code> items such as:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UpdateResourceFeature</span> <span style="color:#000;font-weight:bold">extends</span> Feature
{
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>(Request <span style="color:#008080">$request</span>)
    {
        <span style="color:#998;font-style:italic">// 1. @TODO: validate request input (format &amp; length)
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 2. @TODO: verify access to resource
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 3. @TODO: update resource
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 4. @TODO: save audit activity (async)
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 5. @TODO: notify followers (async)
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 6. @TODO: respond with update status
</span><span style="color:#998;font-style:italic"></span>    }
}
</code></pre></div><p>This approach gives the benefit of an organised and defined workflow, it enhances productivity, focus and visibility by summarising the steps as an overview of what it is to be implemented. In addition to the benefit of editors listing those when needed:</p>
<p><img src="/media/images/workflow/ide-todo.png" alt="Workflow IDE Todo"></p>
</li>
<li>
<p>Start by writing the test for the feature: it is a request to call the route with one of the acceptance cases with input params (if applicable) to execute this feature. At this step, we will have to create the route, controller and controller method to serve the feature, and add the <code>serve(UpdateResourceFeature::class)</code> line to the controller method.</p>
</li>
<li>
<p>Now that we&rsquo;ve written our first test case to execute the feature, it sure will fail because our Feature class is still empty. Now, we can start filling this feature with jobs by replacing each of these steps with the Job or Operation class that fulfils it, following the workflows below.</p>
</li>
</ol>
<h3 ref="writing-operations" >Writing Operations</h3><a class="anchor" id="writing-operations"></a>
<p>Similar to Features, Operations group multiple Jobs that are often executed together, or their combination form a single piece of functionality that itself can be split into multiple reusable steps. However, they differ in testing.</p>
<ol>
<li>
<p>Generate an Operation class, which will create its test class along.</p>
</li>
<li>
<p>Open the Operation class and describe the steps that implement the functionality in comments</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">NotifyFollowersOperation</span> <span style="color:#000;font-weight:bold">extends</span> Operation
{
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>(Request <span style="color:#008080">$request</span>)
    {
        <span style="color:#998;font-style:italic">// 1. @TODO: query followers IDs (paginate)
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 2. @TODO: enqueue notifications in batches of 50
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 3. @TODO: return status
</span><span style="color:#998;font-style:italic"></span>    }
}
</code></pre></div></li>
<li>
<p>Start writing the test for the operation: It is a unit test to ensure one thing:</p>
<blockquote>
<p>That it runs the correct jobs with the correct parameters, in the correct order.</p>
</blockquote>
<p>Jobs don&rsquo;t really run within an Operation test, we rely on the unit test of the single job to ensure its integrity, while operations are about running multiple jobs in sequence. We achieve this by <a href="http://docs.mockery.io/en/latest/reference/partial_mocks.html">partially mocking</a> the Operation class.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#008080">$mOperation</span> <span style="color:#000;font-weight:bold">=</span> Mockery<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">mock</span>(NotifyFollowersOperation<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">makePartial</span>();
</code></pre></div><p>And then we ensure it runs and returns as expected:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#008080">$mOperation</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">shouldReceive</span>(<span style="color:#d14">&#39;run&#39;</span>)
    <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">with</span>(GetFollowersJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [<span style="color:#d14">&#39;userId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$userId</span>, <span style="color:#d14">&#39;fields&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;id&#39;</span>])
    <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">once</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">andReturn</span>(<span style="color:#008080">$result</span>);
</code></pre></div><p>With this we have drawn a map of how we would like our codebase to be composed on the outside, and what is expected from each unit for this implementation. It is now that we start detecting reusable units and we adjust as desired. For example we might figure that a similar functionality is already implemented and needs a simple adjustment to be used in the current operation or feature, so we go ahead and include a <code>@TODO</code> item to update it.</p>
<p>Of course, this is an iterative process where we rarely get things right from the first time so feel free to draft as many possibilities until you are satisfied with the final result, then start filling Job classes with implementation.</p>
<p>At this stage we would have had to create our Job classes so that we cloud use them in the test of our Operation and Feature classes, next will be to fill those Jobs with implementation.</p>
</li>
</ol>
<h3 ref="writing-jobs" >Writing Jobs</h3><a class="anchor" id="writing-jobs"></a>
<p>Resulting from our previous steps of the workflow, a list of tasks that we can start ticking off and our feature will be implemented completely by the end. All that is left is to start filling Job classes with implementations.</p>
<ol>
<li>If you hadn&rsquo;t generated the Job class previously, generate a Job class for each of the items previously marked as a &ldquo;to do&rdquo; item. It is usually best to generate one class at a time, fill it, ensure that it works as expected and that it provides the functionality required and then move on to the next. As for the sequence of generating the jobs, it is usually best to follow the sequence in the Feature class.</li>
<li>Open the generated Job class and start writing functionality. If you are into TDD, you may prefer to open the test file and write your expectations first. Nevertheless, it is not important nor does it affect the outcome to whether you write the test or the implementation first; whichever suites you best.</li>
</ol>
<h2 ref="code" >Code</h2><a class="anchor" id="code"></a>
<p>Let&rsquo;s exercise this workflow with a demo. If you prefer to read the resulting code you can find it on <a href="https://github.com/lucid-architecture/demo-workflow">https://github.com/lucid-architecture/demo-workflow</a></p>
<p>To simplify this exercise, we will be working with a <a href="https://github.com/lucid-architecture/laravel-microservice">Lucid Microservice</a> installation.</p>
<p>Create project</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> composer create-project lucid-arch/laravel-microservice workflow-demo
</code></pre></div><p>Generate Feature</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">lucid make:feature UpdateArticle
</code></pre></div><p>Fill the Feature preliminarily to know what steps would fulfil its functionality</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Features;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Feature;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Http\Request;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UpdateArticleFeature</span> <span style="color:#000;font-weight:bold">extends</span> Feature
{
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>(Request <span style="color:#008080">$request</span>)
    {
        <span style="color:#998;font-style:italic">// 1. @TODO: validate request input (format &amp; length)
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 2. @TODO: verify access to resource
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 3. @TODO: update resource
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 4. @TODO: save audit activity (async)
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 5. @TODO: notify followers (async)
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#998;font-style:italic">// 6. @TODO: respond with update status
</span><span style="color:#998;font-style:italic"></span>    }
}
</code></pre></div><p>And now we tackle these jobs and operations one by one.</p>
<h3 ref="step-1---validate-input" >Step 1 - Validate Input</h3><a class="anchor" id="step-1---validate-input"></a>
<p><code>// 1. @TODO: validate request input (format &amp; length)</code></p>
<p>Generate the class with <code>lucid make:job ValidateArticleInput Article</code> and fill it with the expected content</p>
<p><code>app/Domains/Article/Jobs/ValidateArticleInputJob.php</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Article\Jobs;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Job;
<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Validator;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ValidateArticleInputJob</span> <span style="color:#000;font-weight:bold">extends</span> Job
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var array
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$input</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var array
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$rules</span> <span style="color:#000;font-weight:bold">=</span> [
        <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [<span style="color:#d14">&#39;required&#39;</span>, <span style="color:#d14">&#39;string&#39;</span>, <span style="color:#d14">&#39;max:100&#39;</span>],
        <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [<span style="color:#d14">&#39;required&#39;</span>, <span style="color:#d14">&#39;string&#39;</span>, <span style="color:#d14">&#39;max:1000&#39;</span>],
    ];

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Create a new job instance.
</span><span style="color:#d14">     * @param array $input
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(<span style="color:#000;font-weight:bold">array</span> <span style="color:#008080">$input</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">input</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$input</span>;
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Execute the job.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @param Validator $validator
</span><span style="color:#d14">     * @return bool
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @throws \Lucid\Foundation\InvalidInputException
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>(Validator <span style="color:#008080">$validator</span>) <span style="color:#000;font-weight:bold">:</span> bool
    {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#008080">$validator</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">validate</span>(<span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">input</span>, <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">rules</span>);
    }
}
</code></pre></div><p>Now test it to ensure it works as expected</p>
<p><code>tests/Domains/Article/Jobs/ValidateArticleInputJob.php</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Article\Tests\Jobs;

<span style="color:#000;font-weight:bold">use</span> App\Domains\Article\Jobs\ValidateArticleInputJob;
<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Validator;
<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ValidateArticleInptJobTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_validate_article_input_job</span>()
    {
        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ValidateArticleInputJob([
            <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;The Title&#39;</span>,
            <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;The content of the article goes here.&#39;</span>,
        ]);

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertTrue</span>(<span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>(app(Validator<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)));
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * @dataProvider articleInputValidationProvider
</span><span style="color:#d14">     * @expectedException \Lucid\Foundation\InvalidInputException
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_validating_article_input_job_rules</span>(<span style="color:#008080">$title</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>, <span style="color:#008080">$content</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>)
    {
        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ValidateArticleInputJob(compact(<span style="color:#d14">&#39;title&#39;</span>, <span style="color:#d14">&#39;content&#39;</span>));
        <span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>(app(Validator<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>));
    }

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">articleInputValidationProvider</span>()
    {
        <span style="color:#000;font-weight:bold">return</span> [
            <span style="color:#d14">&#39;without title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;The content of the article.&#39;</span>,
            ],
            <span style="color:#d14">&#39;title is empty&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;&#39;</span>,
                <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;The content of the article.&#39;</span>,
            ],
            <span style="color:#d14">&#39;without content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;The Title Only&#39;</span>,
            ],
            <span style="color:#d14">&#39;content is empty&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;The Title Here&#39;</span>,
                <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;&#39;</span>,
            ],
            <span style="color:#d14">&#39;max title length&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> str_repeat(<span style="color:#d14">&#39;a&#39;</span>, <span style="color:#099">101</span>),
                <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;Content goes here&#39;</span>,
            ],
            <span style="color:#d14">&#39;max content length&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;Title here&#39;</span>,
                <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> str_repeat(<span style="color:#d14">&#39;a&#39;</span>, <span style="color:#099">1001</span>),
            ],
        ];
    }
}
</code></pre></div><p>Running the tests now will yield the following results</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PHPUnit 7.5.8 by Sebastian Bergmann and contributors.

.......I..                                                        <span style="color:#099">10</span> / <span style="color:#099">10</span> <span style="color:#000;font-weight:bold">(</span>100%<span style="color:#000;font-weight:bold">)</span>

Time: <span style="color:#099">351</span> ms, Memory: 18.00 MB

OK, but incomplete, skipped, or risky tests!
Tests: 10, Assertions: 9, Incomplete: 1.
</code></pre></div><p>I know, the incomplete test is annoying, but it is there for a purpose! This is the Feature test, telling us that we&rsquo;re not done yet. Lucid test files are initially generated with a <code>markTestIncomplete</code> for that purpose.</p>
<hr>
<h3 ref="step-2---authorise-access" >Step 2 - Authorise Access</h3><a class="anchor" id="step-2---authorise-access"></a>
<p><code>// 2. @TODO: verify access to resource</code></p>
<p>Generate Job with <code>lucid make:job AuthoriseArticleUpdateJob Article</code></p>
<p>This job will require some setup before we can dive into it since it deals with database. We will use SQLite for testing, which will work as-is with any other SQL database, thanks to <a href="https://laravel.com/docs/5.4/eloquent">Eloquent</a>.</p>
<p>Update <code>phpunit.xml</code> to run the tests in an SQLite memory instance</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">...
        <span style="color:#000080">&lt;server</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;DB_CONNECTION&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;sqlite&#34;</span><span style="color:#000080">/&gt;</span>
        <span style="color:#000080">&lt;server</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;DB_DATABASE&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;:memory:&#34;</span><span style="color:#000080">/&gt;</span>
    <span style="color:#000080">&lt;/php&gt;</span>
<span style="color:#000080">&lt;/phpunit&gt;</span>
</code></pre></div><p>A fix is required for factories to work, go to <code>database/factories/ModelFactory.php</code> and change the namespace of <code>User::class</code> to <code>App\Data\Models\User::class</code></p>
<p>Generate a migration to create our Article model&rsquo;s table</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">php artisan make:migration create_articles_table
</code></pre></div><p>Fill the migration as follows</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">use</span> Illuminate\Support\Facades\Schema;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Schema\Blueprint;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Migrations\Migration;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CreateArticlesTable</span> <span style="color:#000;font-weight:bold">extends</span> Migration
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * Run the migrations.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return void
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">up</span>()
    {
        Schema<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">create</span>(<span style="color:#d14">&#39;articles&#39;</span>, <span style="color:#000;font-weight:bold">function</span> (Blueprint <span style="color:#008080">$table</span>) {
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">bigIncrements</span>(<span style="color:#d14">&#39;id&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">timestamps</span>();
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">string</span>(<span style="color:#d14">&#39;title&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">text</span>(<span style="color:#d14">&#39;content&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">unsignedBigInteger</span>(<span style="color:#d14">&#39;user_id&#39;</span>);

            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">foreign</span>(<span style="color:#d14">&#39;user_id&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">references</span>(<span style="color:#d14">&#39;id&#39;</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">on</span>(<span style="color:#d14">&#39;users&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">onDelete</span>(<span style="color:#d14">&#39;cascade&#39;</span>);
        });
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Reverse the migrations.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return void
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">down</span>()
    {
        Schema<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">dropIfExists</span>(<span style="color:#d14">&#39;articles&#39;</span>);
    }
}
</code></pre></div><p>Now we can create our <code>Article</code> model. Create <code>app/Data/Models/Article.php</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Data\Models;

<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Eloquent\Model;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Article</span> <span style="color:#000;font-weight:bold">extends</span> Model
{
    <span style="color:#000;font-weight:bold">protected</span> <span style="color:#008080">$fillable</span> <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;title&#39;</span>, <span style="color:#d14">&#39;content&#39;</span>];

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">user</span>()
    {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">belongsTo</span>(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#d14">&#39;user_id&#39;</span>);
    }
}
</code></pre></div><p>Add the relationship <code>User &lt;&gt; Article</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">articles</span>()
{
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">hasMany</span>(Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#d14">&#39;user_id&#39;</span>);
}
</code></pre></div><p>Create <code>Article</code> factory to help us with our tests</p>
<p><code>database/factories/ArticleFactory.php</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#008080">$factory</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">define</span>(App\Data\Models\Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#000;font-weight:bold">function</span> (Faker\Generator <span style="color:#008080">$faker</span>) {
    <span style="color:#000;font-weight:bold">return</span> [
        <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$faker</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">title</span>,
        <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$faker</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">realText</span>,
        <span style="color:#d14">&#39;user_id&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">function</span> () {
            <span style="color:#000;font-weight:bold">return</span> factory(App\Data\Models\User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>;
        },
    ];
});
</code></pre></div><p>Now we are ready to start writing our job.</p>
<p><code>app/Domains/Article/Jobs/AuthoriseArticleUpdateJob.php</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Article\Jobs;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Job;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Eloquent\ModelNotFoundException;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">AuthoriseArticleUpdateJob</span> <span style="color:#000;font-weight:bold">extends</span> Job
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var User
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$user</span>;
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var int
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$articleId</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Create a new job instance.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @param User $user
</span><span style="color:#d14">     * @param int $articleId
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(User <span style="color:#008080">$user</span>, int <span style="color:#008080">$articleId</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">user</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$user</span>;
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$articleId</span>;
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Execute the job.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @throws ModelNotFoundException
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>()
    {
                <span style="color:#998;font-style:italic">// only the owner of the article is authorised to update it.
</span><span style="color:#998;font-style:italic"></span>        User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">where</span>(<span style="color:#d14">&#39;id&#39;</span>, <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>)
                    <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">whereHas</span>(<span style="color:#d14">&#39;articles&#39;</span>, <span style="color:#000;font-weight:bold">function</span> (<span style="color:#008080">$query</span>) {
            <span style="color:#008080">$query</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">where</span>(<span style="color:#d14">&#39;id&#39;</span>, <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span>);
        })<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">firstOrFail</span>();
    }
}
</code></pre></div><p>This job simply fetches the user with the intended article as a relationship with a <code>firstOrFail</code> which will throw a <code>ModelNotFoundException</code> if the record is not found, indicating that either one of the records doesn&rsquo;t exist (user or article) or the relationship between them doesn&rsquo;t exist, meaning that the intended article doesn&rsquo;t belong to this user.</p>
<p>Then we write the test to ensure this functionality serves as intended.</p>
<p><code>tests/Domains/Article/Jobs/AuthoriseArticleUpdateJonTest.php</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Article\Tests\Jobs;

<span style="color:#000;font-weight:bold">use</span> App\Data\Models\Article;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\RefreshDatabase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Article\Jobs\AuthoriseArticleUpdateJob;
<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">AuthoriseArticleUpdateJobTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">use</span> RefreshDatabase;
    <span style="color:#000;font-weight:bold">use</span> DatabaseMigrations;

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_authorise_article_update_job</span>()
    {
        <span style="color:#008080">$article</span> <span style="color:#000;font-weight:bold">=</span> factory(Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$user</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$article</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">user</span>;

        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AuthoriseArticleUpdateJob(<span style="color:#008080">$user</span>, <span style="color:#008080">$article</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>);

        <span style="color:#998;font-style:italic">// this usually throws ModelNotFoundException,
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// if the user was not found. Not having anything returned is a good sign
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertNull</span>(<span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>());
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * @expectedException \Illuminate\Database\Eloquent\ModelNotFoundException
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_fails_authorisation_for_different_user</span>()
    {
        <span style="color:#008080">$article</span> <span style="color:#000;font-weight:bold">=</span> factory(Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$anotherUser</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AuthoriseArticleUpdateJob(<span style="color:#008080">$anotherUser</span>, <span style="color:#008080">$article</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>);

                <span style="color:#998;font-style:italic">// must throw ModelNotFoundException
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>();
    }
}
</code></pre></div><hr>
<h3 ref="step-3---save-article" >Step 3 - Save Article</h3><a class="anchor" id="step-3---save-article"></a>
<p><code>// 3. @TODO: update resource</code></p>
<p>Generate Job <code>lucid make:job SaveArticle Article</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Article\Jobs;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Job;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\Article;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SaveArticleJob</span> <span style="color:#000;font-weight:bold">extends</span> Job
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var string
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$title</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var string
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$content</span>;
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var int
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$articleId</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Create a new job instance.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @param int $articleId
</span><span style="color:#d14">     * @param string $title
</span><span style="color:#d14">     * @param string $content
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(int <span style="color:#008080">$articleId</span>, string <span style="color:#008080">$title</span>, string <span style="color:#008080">$content</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">title</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$title</span>;
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">content</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$content</span>;
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$articleId</span>;
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Execute the job.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return int The number of records that were changed.
</span><span style="color:#d14">     *              It will be 1 if update was successful.
</span><span style="color:#d14">     *              Otherwise it&#39;s a 0.
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>() <span style="color:#000;font-weight:bold">:</span> int
    {
        <span style="color:#000;font-weight:bold">return</span> Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">where</span>(<span style="color:#d14">&#39;id&#39;</span>, <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">update</span>([
            <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">title</span>,
            <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">content</span>,
        ]);
    }
}
</code></pre></div><p>Saving an article is simple, we only need its identifier and the new attributes.</p>
<p>And its test</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Article\Tests\Jobs;

<span style="color:#000;font-weight:bold">use</span> App\Data\Models\Article;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Article\Jobs\SaveArticleJob;
<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\RefreshDatabase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SaveArticleJobTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">use</span> RefreshDatabase;
    <span style="color:#000;font-weight:bold">use</span> DatabaseMigrations;

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_save_article_job</span>()
    {
        <span style="color:#008080">$title</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;New Unique Title&#39;</span>;
        <span style="color:#008080">$content</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;Replaced content with this new piece.&#39;</span>;

        <span style="color:#008080">$article</span> <span style="color:#000;font-weight:bold">=</span> factory(Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SaveArticleJob(<span style="color:#008080">$article</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>, <span style="color:#008080">$title</span>, <span style="color:#008080">$content</span>);

        <span style="color:#998;font-style:italic">// we expect one record to be updateed only.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertEquals</span>(<span style="color:#099">1</span>, <span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>());
    }
}
</code></pre></div><hr>
<h3 ref="step-4---add-audit-entry-asynchronously" >Step 4 - Add audit entry asynchronously</h3><a class="anchor" id="step-4---add-audit-entry-asynchronously"></a>
<p><code>// 4. @TODO: save audit activity (async)</code></p>
<p>This is a fancy step that in most cases won&rsquo;t be needed, but it&rsquo;s been added to the workflow to showcase working with async using Laravel queues. Logging activity is simply adding a record to an <code>activity</code> database table, but adding activity should not be a blocking action for it is not required by the response to the user, to whom we should be responding as quick as possible.</p>
<p>Create <code>activity</code> table <code>php artisan make:migration create_activity_table</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">use</span> Illuminate\Support\Facades\Schema;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Schema\Blueprint;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Migrations\Migration;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CreateActivityTable</span> <span style="color:#000;font-weight:bold">extends</span> Migration
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * Run the migrations.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return void
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">up</span>()
    {
        Schema<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">create</span>(<span style="color:#d14">&#39;activity&#39;</span>, <span style="color:#000;font-weight:bold">function</span> (Blueprint <span style="color:#008080">$table</span>) {
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">bigIncrements</span>(<span style="color:#d14">&#39;id&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">string</span>(<span style="color:#d14">&#39;description&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">unsignedBigInteger</span>(<span style="color:#d14">&#39;user_id&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">timestamps</span>();

            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">foreign</span>(<span style="color:#d14">&#39;user_id&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">references</span>(<span style="color:#d14">&#39;id&#39;</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">on</span>(<span style="color:#d14">&#39;users&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">onDelete</span>(<span style="color:#d14">&#39;cascade&#39;</span>);
        });
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Reverse the migrations.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return void
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">down</span>()
    {
        Schema<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">dropIfExists</span>(<span style="color:#d14">&#39;activity&#39;</span>);
    }
}
</code></pre></div><p>Generate model <code>lucid make:model ActivityLog</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Data\Models;

<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Eloquent\Model;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ActivityLog</span> <span style="color:#000;font-weight:bold">extends</span> Model
{
    <span style="color:#000;font-weight:bold">protected</span> <span style="color:#008080">$table</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;activity&#39;</span>;

    <span style="color:#000;font-weight:bold">protected</span> <span style="color:#008080">$fillable</span> <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;user_id&#39;</span>, <span style="color:#d14">&#39;description&#39;</span>];

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">actor</span>()
    {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">belongsTo</span>(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#d14">&#39;user_id&#39;</span>);
    }
}
</code></pre></div><p>Generate job <code>lucid make:job LogActivity Activity --queue</code></p>
<p>You will notice that the generated job <code>extends QueueableJob</code> instead of <code>Job</code> which will instruct the dispatcher when calling <code>$this-&gt;run(Job)</code> in the Feature or Operation to run it asynchronously in Laravel <a href="https://laravel.com/docs/master/queues">queue</a> as configured in the application.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Activity\Jobs;

<span style="color:#000;font-weight:bold">use</span> App\Data\Models\ActivityLog;
<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\QueueableJob;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">LogActivityJob</span> <span style="color:#000;font-weight:bold">extends</span> QueueableJob
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var int
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$userId</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var string
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$description</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Create a new job instance.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @param int $userId
</span><span style="color:#d14">     * @param string $description
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(int <span style="color:#008080">$userId</span>, string <span style="color:#008080">$description</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">userId</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$userId</span>;
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">description</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$description</span>;
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Execute the job.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return ActivityLog
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>() <span style="color:#000;font-weight:bold">:</span> ActivityLog
    {
        <span style="color:#000;font-weight:bold">return</span> ActivityLog<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">create</span>([
            <span style="color:#d14">&#39;user_id&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">userId</span>,
            <span style="color:#d14">&#39;description&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">description</span>,
        ]);
    }
}
</code></pre></div><p>And its test</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\Activity\Tests\Jobs;

<span style="color:#000;font-weight:bold">use</span> App\Data\Models\ActivityLog;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Activity\Jobs\LogActivityJob;
<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\RefreshDatabase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">LogActivityJobTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">use</span> RefreshDatabase;
    <span style="color:#000;font-weight:bold">use</span> DatabaseMigrations;

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_log_activity_job</span>()
    {
        <span style="color:#008080">$user</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> LogActivityJob(<span style="color:#008080">$user</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>, <span style="color:#d14">&#34;tested logging activity&#34;</span>);

        <span style="color:#008080">$activity</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>();
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertInstanceOf</span>(ActivityLog<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#008080">$activity</span>);
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertEquals</span>(<span style="color:#008080">$activity</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">user_id</span>, <span style="color:#008080">$user</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>);
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertEquals</span>(<span style="color:#008080">$activity</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">description</span>, <span style="color:#d14">&#34;tested logging activity&#34;</span>);

    }
}
</code></pre></div><hr>
<h3 ref="step-5---notify-followers" >Step 5 - Notify Followers</h3><a class="anchor" id="step-5---notify-followers"></a>
<p><code>// 5. @TODO: notify followers (async)</code></p>
<p>Notifying followers here is meant as if every follower of this author is subscribed to receive some sort of a notification  everytime this author publishes a new post. It is made of two steps:</p>
<ol>
<li>Fetching a user&rsquo;s followers</li>
<li>Sending them notifications</li>
</ol>
<p>Similar to our activity log, since it is not essential for the response to the user, we better do these steps asynchronously.</p>
<p>Since each of these steps should be in its own Job according to the Lucid principles, and so that we don&rsquo;t run two jobs every time we need to notify followers, Operations are handy in this scenario. But we will follow an outward approach where we start by creating the jobs and ensuring that they work as expected, then create the operation that runs them, just as we are doing with our Feature here. This approach is recommended because after finishing with the jobs we will know what to the Operation should expect as input parameters based on what the jobs require.</p>
<p>Create <code>follows</code> table migration <code>php artisan:make migration create_followers_table</code></p>
<p>which will be our pivot table to link users with their followers.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">use</span> Illuminate\Support\Facades\Schema;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Schema\Blueprint;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Migrations\Migration;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CreateFollowsTable</span> <span style="color:#000;font-weight:bold">extends</span> Migration
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * Run the migrations.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return void
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">up</span>()
    {
        Schema<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">create</span>(<span style="color:#d14">&#39;follows&#39;</span>, <span style="color:#000;font-weight:bold">function</span> (Blueprint <span style="color:#008080">$table</span>) {
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">unsignedBigInteger</span>(<span style="color:#d14">&#39;author_id&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">unsignedBigInteger</span>(<span style="color:#d14">&#39;follower_id&#39;</span>);
            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">timestamps</span>();

            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">foreign</span>(<span style="color:#d14">&#39;author_id&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">references</span>(<span style="color:#d14">&#39;id&#39;</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">on</span>(<span style="color:#d14">&#39;users&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">onDelete</span>(<span style="color:#d14">&#39;cascade&#39;</span>);

            <span style="color:#008080">$table</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">foreign</span>(<span style="color:#d14">&#39;follower_id&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">references</span>(<span style="color:#d14">&#39;id&#39;</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">on</span>(<span style="color:#d14">&#39;users&#39;</span>)
                <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">onDelete</span>(<span style="color:#d14">&#39;cascade&#39;</span>);

        });
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Reverse the migrations.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return void
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">down</span>()
    {
        Schema<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">dropIfExists</span>(<span style="color:#d14">&#39;follows&#39;</span>);
    }
}
</code></pre></div><p>Add relationship method and <code>Notifiable</code> trait to <code>User</code> model</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">User</span> <span style="color:#000;font-weight:bold">extends</span> Authenticatable
{
    <span style="color:#000;font-weight:bold">use</span> Notifiable;

    <span style="color:#998;font-style:italic">//...
</span><span style="color:#998;font-style:italic"></span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">followers</span>()
    {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">belongsToMany</span>(self<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>,
            <span style="color:#d14">&#39;follows&#39;</span>,
            <span style="color:#d14">&#39;author_id&#39;</span>,
            <span style="color:#d14">&#39;follower_id&#39;</span>)
            <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">withTimestamps</span>();
    }
}
</code></pre></div><p>Generate Job to fetch user followers <code>lucid make:job GetUserFollowers User</code></p>
<blockquote>
<p>In a real-life scenario you should paginate followers instead of fetching them all at once, this is done this way to keep this demo simple.</p>
</blockquote>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\User\Jobs;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Job;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Eloquent\Collection;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GetUserFollowersJob</span> <span style="color:#000;font-weight:bold">extends</span> Job
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var int
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$userId</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Create a new job instance.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @param int $userId
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(int <span style="color:#008080">$userId</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">userId</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$userId</span>;
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Execute the job.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @return Collection of User models
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>() <span style="color:#000;font-weight:bold">:</span> Collection
    {
        <span style="color:#000;font-weight:bold">return</span> User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">find</span>(<span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">userId</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">followers</span>;
    }
}
</code></pre></div><p>And its test</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\User\Tests\Jobs;

<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> App\Domains\User\Jobs\GetUserFollowersJob;
<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\RefreshDatabase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GetUserFollowersJobTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">use</span> RefreshDatabase;
    <span style="color:#000;font-weight:bold">use</span> DatabaseMigrations;

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_get_user_followers_job</span>()
    {
        <span style="color:#998;font-style:italic">// prepare
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#008080">$user</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$followers</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#099">5</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$user</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">followers</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">saveMany</span>(<span style="color:#008080">$followers</span>);

        <span style="color:#998;font-style:italic">// test
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> GetUserFollowersJob(<span style="color:#008080">$user</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>);

        <span style="color:#008080">$retreived</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>();

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertEquals</span>(<span style="color:#008080">$followers</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">toArray</span>(),
            <span style="color:#008080">$retreived</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">makeHidden</span>([<span style="color:#d14">&#39;pivot&#39;</span>, <span style="color:#d14">&#39;email_verified_at&#39;</span>])<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">toArray</span>());
    }
}
</code></pre></div><p>Generate notification to be sent <code>php artisan make:notification ArticlePublished</code></p>
<p>We will use this class as-is, no modifications are required here.</p>
<p>Generate Job to send notifications to users <code>lucid make:job NotifyFollowers User</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\User\Jobs;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Job;
<span style="color:#000;font-weight:bold">use</span> App\Notifications\ArticlePublished;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Database\Eloquent\Collection;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Support\Facades\Notification;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">NotifyFollowersJob</span> <span style="color:#000;font-weight:bold">extends</span> Job
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var Collection
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$followers</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Create a new job instance.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @param Collection $followers of User models
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(Collection <span style="color:#008080">$followers</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">followers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$followers</span>;
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * Execute the job.
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>()
    {
        Notification<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">send</span>(<span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">followers</span>, <span style="color:#000;font-weight:bold">new</span> ArticlePublished());
    }
}
</code></pre></div><p>And its test</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Domains\User\Tests\Jobs;

<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> App\Notifications\ArticlePublished;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Support\Facades\Notification;
<span style="color:#000;font-weight:bold">use</span> App\Domains\User\Jobs\NotifyFollowersJob;
<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\RefreshDatabase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">NotifyFollowersJobTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">use</span> RefreshDatabase;
    <span style="color:#000;font-weight:bold">use</span> DatabaseMigrations;

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_notify_followers_job</span>()
    {
        <span style="color:#008080">$users</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#099">5</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$job</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> NotifyFollowersJob(<span style="color:#008080">$users</span>);

        Notification<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">shouldReceive</span>(<span style="color:#d14">&#39;send&#39;</span>)
            <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">once</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">with</span>(<span style="color:#008080">$users</span>, ArticlePublished<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>);

        <span style="color:#008080">$job</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>();
    }
}
</code></pre></div><p>Generate Operation to run both jobs <code>lucid make:operation NotifyFollowers --queue</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Operations;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\QueueableOperation;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Http\Request;
<span style="color:#000;font-weight:bold">use</span> App\Domains\User\Jobs\NotifyFollowersJob;
<span style="color:#000;font-weight:bold">use</span> App\Domains\User\Jobs\GetUserFollowersJob;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">NotifyFollowersOperation</span> <span style="color:#000;font-weight:bold">extends</span> QueueableOperation
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var int
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$userId</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * NotifyFollowersOperation constructor.
</span><span style="color:#d14">     * @param int $userId
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(int <span style="color:#008080">$userId</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">userId</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$userId</span>;
    }

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>()
    {
        <span style="color:#008080">$followers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(GetUserFollowersJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [
            <span style="color:#d14">&#39;userId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">userId</span>
        ]);

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(NotifyFollowersJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, compact(<span style="color:#d14">&#39;followers&#39;</span>));
    }
}
</code></pre></div><p>And its test. The objective of testing operations is <strong>to ensure they run the correct jobs with the correct parameters in the correct sequence</strong>. It is not necessary to run the actual job because we would be testing the job twice while we should be keen on not reinventing the wheel and replicating tests, we rely on the Job&rsquo;s tests to provide its guarantee.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Tests\Operations;

<span style="color:#000;font-weight:bold">use</span> Mockery;
<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> App\Operations\NotifyFollowersOperation;
<span style="color:#000;font-weight:bold">use</span> App\Domains\User\Jobs\NotifyFollowersJob;
<span style="color:#000;font-weight:bold">use</span> App\Domains\User\Jobs\GetUserFollowersJob;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\RefreshDatabase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">NotifyFollowersOperationTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">use</span> RefreshDatabase;
    <span style="color:#000;font-weight:bold">use</span> DatabaseMigrations;

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">tearDown</span>()<span style="color:#000;font-weight:bold">:</span> void
    {
        <span style="color:#000;font-weight:bold">parent</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">tearDown</span>();

        Mockery<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">close</span>();
    }

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_notifying_followers</span>()
    {
        <span style="color:#008080">$user</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();
        <span style="color:#008080">$followers</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, <span style="color:#099">5</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$op</span> <span style="color:#000;font-weight:bold">=</span> Mockery<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">mock</span>(NotifyFollowersOperation<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [<span style="color:#008080">$user</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>])
            <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">makePartial</span>();

        <span style="color:#008080">$op</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">shouldReceive</span>(<span style="color:#d14">&#39;run&#39;</span>)
            <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">once</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">with</span>(GetUserFollowersJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [<span style="color:#d14">&#39;userId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$user</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>])
            <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">andReturn</span>(<span style="color:#008080">$followers</span>);

        <span style="color:#008080">$op</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">shouldReceive</span>(<span style="color:#d14">&#39;run&#39;</span>)
            <span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">once</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">with</span>(NotifyFollowersJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, compact(<span style="color:#d14">&#39;followers&#39;</span>));

        <span style="color:#008080">$op</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">handle</span>();
    }
}
</code></pre></div><hr>
<h3 ref="step-6---respond-with-update-status" >Step 6 - Respond with Update Status</h3><a class="anchor" id="step-6---respond-with-update-status"></a>
<p>Simply return a JSON response using built-in <code>Http\RespondWithJsonJob</code> as seen in the next step.</p>
<h3 ref="step-7----finally-compose-feature" >Step 7 -  Finally: Compose Feature</h3><a class="anchor" id="step-7----finally-compose-feature"></a>
<p>Now that we have all the jobs ready and we&rsquo;re sure that they are working as expected through their unit tests, all we have to do now is run them in sequence in our Feature class and pass the correct parameters and everything should work as expected.</p>
<p>Create controller <code>lucid make:controller Article --plain</code></p>
<p>Add <code>update</code> controller method to serve the feature, and route in <code>routes/web.php</code></p>
<p><code>Route::put('/articles/{articleId}', 'ArticleController@update');</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Http\Controllers;

<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Http\Controller;
<span style="color:#000;font-weight:bold">use</span> App\Features\UpdateArticleFeature;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ArticleController</span> <span style="color:#000;font-weight:bold">extends</span> Controller
{
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">update</span>(<span style="color:#008080">$articleId</span>)
    {
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">serve</span>(UpdateArticleFeature<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>,
            [<span style="color:#d14">&#39;articleId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> intval(<span style="color:#008080">$articleId</span>)]);
    }
}
</code></pre></div><p>Fill the feature&rsquo;s <code>handle</code> method</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Features;

<span style="color:#000;font-weight:bold">use</span> Auth;
<span style="color:#000;font-weight:bold">use</span> Lucid\Foundation\Feature;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Http\Request;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Article\Jobs\SaveArticleJob;
<span style="color:#000;font-weight:bold">use</span> App\Operations\NotifyFollowersOperation;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Activity\Jobs\LogActivityJob;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Http\Jobs\RespondWithJsonJob;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Article\Jobs\ValidateArticleInputJob;
<span style="color:#000;font-weight:bold">use</span> App\Domains\Article\Jobs\AuthoriseArticleUpdateJob;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UpdateArticleFeature</span> <span style="color:#000;font-weight:bold">extends</span> Feature
{
    <span style="color:#d14">/**
</span><span style="color:#d14">     * @var int
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#008080">$articleId</span>;

    <span style="color:#d14">/**
</span><span style="color:#d14">     * CreateArticleFeature constructor.
</span><span style="color:#d14">     *
</span><span style="color:#d14">     * @param int $articleId
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> __construct(int <span style="color:#008080">$articleId</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$articleId</span>;
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * @param Request $request
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">handle</span>(Request <span style="color:#008080">$request</span>)
    {
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(<span style="color:#000;font-weight:bold">new</span> ValidateArticleInputJob(<span style="color:#008080">$request</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">input</span>()));

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(AuthoriseArticleUpdateJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [
            <span style="color:#d14">&#39;user&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> Auth<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">user</span>(),
            <span style="color:#d14">&#39;articleId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span>,
        ]);

        <span style="color:#008080">$isSuccess</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(SaveArticleJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [
            <span style="color:#d14">&#39;articleId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span>,
            <span style="color:#d14">&#39;title&#39;</span><span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$request</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">input</span>(<span style="color:#d14">&#39;title&#39;</span>),
            <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$request</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">input</span>(<span style="color:#d14">&#39;content&#39;</span>),
        ]);

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(LogActivityJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [
            <span style="color:#d14">&#39;userId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> Auth<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">user</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>,
            <span style="color:#d14">&#39;description&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#34;Article updated &#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">articleId</span>,
        ]);

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(NotifyFollowersOperation<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>, [
            <span style="color:#d14">&#39;userId&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> Auth<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">user</span>()<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>,
        ]);

        <span style="color:#000;font-weight:bold">return</span> <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">run</span>(<span style="color:#000;font-weight:bold">new</span> RespondWithJsonJob([<span style="color:#d14">&#39;success&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#008080">$isSuccess</span>]));
    }
}
</code></pre></div><p>And its test</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">namespace</span> App\Tests\Features;

<span style="color:#000;font-weight:bold">use</span> Tests\TestCase;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\User;
<span style="color:#000;font-weight:bold">use</span> App\Data\Models\Article;
<span style="color:#000;font-weight:bold">use</span> App\Features\UpdateArticleFeature;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\RefreshDatabase;
<span style="color:#000;font-weight:bold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UpdateArticleFeatureTest</span> <span style="color:#000;font-weight:bold">extends</span> TestCase
{
    <span style="color:#000;font-weight:bold">use</span> RefreshDatabase;
    <span style="color:#000;font-weight:bold">use</span> DatabaseMigrations;

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_updating_article_feature</span>()
    {
        <span style="color:#008080">$article</span> <span style="color:#000;font-weight:bold">=</span> factory(Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();
        <span style="color:#008080">$user</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">$article</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">user</span>;

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">actingAs</span>(<span style="color:#008080">$user</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">put</span>(<span style="color:#d14">&#34;/articles/</span><span style="color:#d14">$article-&gt;id</span><span style="color:#d14">&#34;</span>, [
            <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;My Updated New Title&#39;</span>,
            <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;Shiny shiny, shiny new content.&#39;</span>,
        ])<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertJson</span>([
            <span style="color:#d14">&#39;status&#39;</span><span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#099">200</span>,
            <span style="color:#d14">&#39;data&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;success&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">true</span>,
            ]
        ]);

        <span style="color:#008080">$retrieved</span> <span style="color:#000;font-weight:bold">=</span> Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">find</span>(<span style="color:#008080">$article</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">id</span>);

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertEquals</span>(<span style="color:#d14">&#39;My Updated New Title&#39;</span>, <span style="color:#008080">$retrieved</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">title</span>);
        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertEquals</span>(<span style="color:#d14">&#39;Shiny shiny, shiny new content.&#39;</span>, <span style="color:#008080">$retrieved</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">content</span>);
    }

    <span style="color:#d14">/**
</span><span style="color:#d14">     * @expectedException \Illuminate\Database\Eloquent\ModelNotFoundException
</span><span style="color:#d14">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">function</span> <span style="color:#900;font-weight:bold">test_updating_article_fails_when_unauthorised</span>()
    {
        <span style="color:#008080">$article</span> <span style="color:#000;font-weight:bold">=</span> factory(Article<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();
        <span style="color:#008080">$anotherUser</span> <span style="color:#000;font-weight:bold">=</span> factory(User<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">class</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">create</span>();

        <span style="color:#008080">$this</span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">actingAs</span>(<span style="color:#008080">$anotherUser</span>)<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">put</span>(<span style="color:#d14">&#34;/articles/</span><span style="color:#d14">$article-&gt;id</span><span style="color:#d14">&#34;</span>, [
            <span style="color:#d14">&#39;title&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;My Updated New Title&#39;</span>,
            <span style="color:#d14">&#39;content&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;Shiny shiny, shiny new content.&#39;</span>,
        ])<span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#008080">assertJson</span>([
            <span style="color:#d14">&#39;status&#39;</span><span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#099">200</span>,
            <span style="color:#d14">&#39;data&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> [
                <span style="color:#d14">&#39;success&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">true</span>,
            ]
        ]);
    }
}
</code></pre></div><h2 ref="notable-observation" >Notable Observation</h2><a class="anchor" id="notable-observation"></a>
<p>Through this workflow, it is important to note how tests cover the scope of the unit only and keeps us from breaking the boudaries where we shouldn&rsquo;t. Especially when it comes to the feature test where it is kept to what it is responsible for, without having to repeat the tests that&rsquo;s been covered by the jobts themselves. However, it might be important to test edge cases at the feature level to ensure that the responses from our backend are consistent and as expected.</p>
<h2 ref="faq" >FAQ</h2><a class="anchor" id="faq"></a>
<p>


<div class="card "><div class="card-body">
    <p class="card-text"><h3 ref="why-sometimes-we-use-userid-and-other-times-the-whole-user" >Why sometimes we use UserId and other times the whole User?</h3><a class="anchor" id="why-sometimes-we-use-userid-and-other-times-the-whole-user"></a>
<p>Because of the scope. For example: <code>AuthoriseArticleUpdateJob</code> might require more information about the user in the future than their ID because the nature of what it does - authorisation. While other jobs such as <code>LogActivityJob</code> and <code>NotifyFollowersOperation</code> are only concerned about the user&rsquo;s identifier, regardless of where and how this was retrieved.</p>
<p>Doing this allows for the reuse of these jobs beyond the scope of this feature alone. We can use them anywhere else (for example from a command where users aren&rsquo;t authenticated) without having to workaround authentication where it doesn&rsquo;t belong.</p>
</p>
  </div></div>




<div class="card "><div class="card-body">
    <p class="card-text"><h3 ref="could-we-have-improved-logging-activity" >Could we have improved logging activity?</h3><a class="anchor" id="could-we-have-improved-logging-activity"></a>
<p>Yes. For example, create a job for each activity (i.e. <code>LogArticleUpdateActivityJob</code> instead of a generic <code>LogActivityJob</code>. It would be preferred over having a string in the feature which is recommended to be avoided when possible but kept here for the simplicity of this exercise.</p>
</p>
  </div></div>
</p>



<div class="card "><div class="card-body">
    <p class="card-text"><h3 ref="can-we-add-more-safety-to-this-code" >Can we add more safety to this code?</h3><a class="anchor" id="can-we-add-more-safety-to-this-code"></a>
<p>Yes, plenty! A simple addition would be to ensure there&rsquo;s a session before proceeding with the feature to avoid errors such as:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">Symfony\Component\Debug\Exception\FatalThrowableError<span style="color:#000;font-weight:bold">:</span> Argument <span style="color:#099">1</span> passed to App\Domains\Article\Jobs\AuthoriseArticleUpdateJob<span style="color:#000;font-weight:bold">::</span><span style="color:#008080">__construct</span>() must be an instance of App\Data\Models\User, <span style="color:#000;font-weight:bold">null</span> given
</code></pre></div><p>This could be done around the HTTP Kernel like in the middleware area.</p>
<p>Another safety check would be to wrap async calls with a <code>try/catch</code> block so that failures in there don&rsquo;t affect the user&rsquo;s response (namely <code>LogActivityJob</code> and <code>NotifyFollowersOperation</code> because they do not dictate the actual status of the update.</p>
</p>
  </div></div>

<h2 ref="where-to-go-from-here" >Where To Go From Here?</h2><a class="anchor" id="where-to-go-from-here"></a>
<p>If you&rsquo;ve just started with Lucid then it would be a good idea to familiarize yourself with Lucid units: <a href="/features">Features</a>, <a href="/jobs">Jobs</a>, <a href="/operations">Operations</a>.
Otherwise, you&rsquo;re ready to kickoff your next project with the architecture it deserves!</p>

		
</div>






	 
	<div class="chevrons">
		<a class="next" href="/cli/" title="CLI Reference" style="margin-right: 0px;">
            <div>
                <p>Next page</p>
                <label>CLI Reference</label>
            </div>
            <i class="fas fa-arrow-right" style="font-size: 1.7em"></i></a>
	</div>
	
	

      </section>

      
      
      <section class="right-menu ">
      
	

		
	
			
		
	    	
	  	
	<div class="TableOfContents">
    <label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What&#39;s on this page</label>
    <nav>
        <ul >
            <li><a href="/micro/getting-started/">Getting Started</a></li>
        </ul>
    </nav>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#brief">Brief</a>
      <ul>
        <li><a href="#writing-features">Writing Features</a></li>
        <li><a href="#writing-operations">Writing Operations</a></li>
        <li><a href="#writing-jobs">Writing Jobs</a></li>
      </ul>
    </li>
    <li><a href="#code">Code</a>
      <ul>
        <li><a href="#step-1---validate-input">Step 1 - Validate Input</a></li>
        <li><a href="#step-2---authorise-access">Step 2 - Authorise Access</a></li>
        <li><a href="#step-3---save-article">Step 3 - Save Article</a></li>
        <li><a href="#step-4---add-audit-entry-asynchronously">Step 4 - Add audit entry asynchronously</a></li>
        <li><a href="#step-5---notify-followers">Step 5 - Notify Followers</a></li>
        <li><a href="#step-6---respond-with-update-status">Step 6 - Respond with Update Status</a></li>
        <li><a href="#step-7----finally-compose-feature">Step 7 -  Finally: Compose Feature</a></li>
      </ul>
    </li>
    <li><a href="#notable-observation">Notable Observation</a></li>
    <li><a href="#faq">FAQ</a></li>
    <li><a href="#where-to-go-from-here">Where To Go From Here?</a></li>
  </ul>
</nav>
</div>

		
	
			
		
	    	
	  	
	<div class="Actions">
	<nav>
		<ul>
				
		    
		    
			
		      <li>
		          <i class='fas fa-calendar'></i>
		          Last update on 28 October 2020
		      </li>
		    
		    

    	</ul>
	</nav>
    
</div>

      </section>
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	<div class="columns">
  <div class="column">
    <h3 style="color: #fdfdfd !important;">Lucid Architecture</h3>
for scalable software.
  </div>
  <div class="column">
    <div style="display: flex; justify-content: flex-end; align-items: center;">
    <div>
        <a href="https://github.com/lucid-architecture" target="_blank"><i class="fab fa-github fa-lg"></i></a>
        <a href="https://lucid-slack.herokuapp.com" target="_blank" style="margin-left: 10px;"><i class="fab fa-slack fa-lg"></i></a>
        <a href="https://www.reddit.com/r/LucidArchitecture/" target="_blank" style="margin-left: 10px;"><i class="fab fa-reddit-alien fa-lg"></i></a>
    </div>
    <div style="margin-left: 50px; margin-top: 6px;">
        <a class="github-button" href="https://github.com/sponsors/lucid-architecture" data-icon="octicon-heart" aria-label="Sponsor @lucid-architecture on GitHub">Sponsor</a>
        <a class="github-button" href="https://github.com/ntkme/github-buttons" data-icon="octicon-star" data-show-count="true" aria-label="Star ntkme/github-buttons on GitHub">Star</a>
    </div>
</div>
  </div>
</div>

	    
	
    </footer>
    



  </body>
</html>
